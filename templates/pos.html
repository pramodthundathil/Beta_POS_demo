<!doctype html>
{% load static %}

<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>BETA-POS</title>

    <!-- Favicon -->
    <link rel="shortcut icon" href="{%static 'assets/images/favicon.ico' %}" />
    <link rel="stylesheet" href="{%static 'assets/css/backend-plugin.min.css' %}">
    <link rel="stylesheet" href="{%static 'assets/css/backend.css?v=1.0.0' %}">
    <link rel="stylesheet" href="{%static 'assets/vendor/@fortawesome/fontawesome-free/css/all.min.css' %}">
    <link rel="stylesheet" href="{%static 'assets/vendor/line-awesome/dist/line-awesome/css/line-awesome.min.css' %}">
    <link rel="stylesheet" href="{%static 'assets/vendor/remixicon/fonts/remixicon.css' %}">
    <!-- <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"> -->
    <link rel="stylesheet" href="{%static 'assets/css/jquery-ui.css' %}">

<!-- 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script> -->
    <style>
        .head-tr-class th {
            background-color: #FF7E41;
        }

        .product-tr td {
            background-color: #f7b596;
        }

        .hover-card-class:hover {
            border: 1px solid black;
            box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;

        }
    </style>
</head>
{% block content %}

<body class="  ">
    <!-- loader Start -->
    <div id="loading">
        <div id="loading-center">
        </div>
    </div>
    <!-- loader END -->
    <!-- Wrapper Start -->
    <div class="iq-top-navbar">
        <div class="iq-navbar-custom">
            <nav class="navbar navbar-expand-lg navbar-light p-0">
                <div class="iq-navbar-logo d-flex align-items-center justify-content-between">
                    <i class="ri-menu-line wrapper-menu"></i>
                    <a href="{%url 'Index' %}" class="header-logo">
                        <img src="{%static 'assets/images/logo.png' %}" class="img-fluid rounded-normal" alt="logo">
                        <h5 class="logo-title ml-3">BETA-POS</h5>

                    </a>
                </div>
                <div class="iq-search-bar device-search">
                    <form action="#" class="searchbox">
                        <!-- <a class="search-link" href="#"><i class="ri-search-line"></i></a>
                        <input type="text" class="text search-input" placeholder="Search here..."> -->
                    </form>
                </div>
                <div class="d-flex align-items-center">
                    <a class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                        aria-controls="navbarSupportedContent" aria-label="Toggle navigation">
                        <i class="ri-menu-3-line"></i>
                    </a>
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav ml-auto navbar-list align-items-center">
                            <li class="nav-item nav-icon dropdown">
                                <a data-bs-toggle="offcanvas" href="#offcanvasExample" role="button" aria-controls="offcanvasExample" class="dropdown-toggle btn border add-btn">
                                    Recent Invoices
                                </a>

                            </li>
                            <li class="nav-item nav-icon dropdown">
                                <a href="{%url 'Index' %}" class=" dropdown-toggle btn border add-btn shadow-none mx-2 d-none d-md-block">
                                    Dashboard
                                </a>

                            </li>
                            <li>
                                <a href="{%url 'CreateOrder' %}" class="btn border add-btn shadow-none mx-2 d-none d-md-block" ><i class="las la-plus mr-2"></i>New Order</a>


                                    <!-- off canvas  -->
                                     
                            </li>
                            
                            
                            <li class="nav-item nav-icon dropdown caption-content">
                                <a href="#" class="search-toggle dropdown-toggle" id="dropdownMenuButton4"
                                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <img src="{%static 'assets/images/user/1.png' %}" class="img-fluid rounded"
                                        alt="user">
                                </a>
                                <div class="iq-sub-dropdown dropdown-menu" aria-labelledby="dropdownMenuButton">
                                    <div class="card shadow-none m-0">
                                        <div class="card-body p-0 text-center">
                                            <div class="media-body profile-detail text-center">
                                                <img src="{%static 'assets/images/page-img/profile-bg.jpg' %}"
                                                    alt="profile-bg" class="rounded-top img-fluid mb-4">
                                                <img src="{%static 'assets/images/user/1.png' %}" alt="profile-img"
                                                    class="rounded profile-img img-fluid avatar-70">
                                            </div>
                                            <div class="p-3">
                                                <h5 class="mb-1">{{request.user}}</h5>
                                                <p class="mb-0">Since {{request.user.added_date}}</p>
                                                <div class="d-flex align-items-center justify-content-center mt-3">
                                                    <a href="" class="btn border mr-2">Profile</a>
                                                    <a href="{%url 'SignOut' %}" class="btn border">Sign Out</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>
    </div>
    <div class="wrapper" style="margin-top: 100px !important;">
        <!-- <div class="content-page"> -->
        <div class="container-fluid">
            <div class="row">
                
                <div class="col-sm-12 col-lg-4">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between">
                            <div class="header-title">
                                <h4 class="card-title">Products</h4>
                            </div>
                        </div>
                        <div class="card-body">
                            <form id="search-form">
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" name="search" id="search-input" placeholder="Search Product By code or name">
                                    <button class="btn btn-outline-secondary" type="button" id="button-addon2" data-toggle="modal" data-target=".bd-example-modal-lg-product"><span style="font-size: larger;">+</span> Add </button>
                                  </div>
                                <!-- <input type="text" class="form-control" name="search" id="search-input" placeholder="Search Product By code or name"><button>+</button> -->
                            </form>
                            <!-- <div class="product-table mt-3 bg-light-info">
                                <div class="" style="height: 200px !important;overflow-y: scroll;">
                                    <div class="table table-striped">
                                        <div id="product-table-body" class="row p-3 justify-content-center">
                                            {% for product in product %}
                                            <div class="col-md-4 card" style="margin-left: 2px;width:30% !important" >
                                            <a href="#" class="add-to-order" data-product-id="{{product.id}}" style="text-decoration: none;">

                                                    <h4>{{product.name}}</h4> 
                                                    <h6>{{product.price}} ({{product.unit_quantity}})</h6>
                                                    <p>Stock: {{product.stock }}</p> 
                                                </a>

                                            </div>
                                            {% endfor %}



                                        </div>
                                    </div>
                                </div>
                            </div> -->
                            
                        
                        </div>
                    </div>

                    <div id="customerdetails">

                        {% include 'ajaxtemplates/customerdetailsonpos.html'%}
                    </div>



                </div>
                <div class="col-sm-12 col-lg-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between">
                            <div class="header-title">
                            
                                <h4 class="card-title">Invoice <span
                                        style="text-align: right;">#{{order.invoice_number}}</span></h4>
                                        <h6 class="text-danger">
                                            {% if order.save_status == True %}
                                            This Invoice is Already Saved Cannot be edited
                                            {% endif%}
                                        </h6>

                            </div>
                            <div class="date header-title">
                                Date: {{order.order_date}}
                                <form action="{%url 'change_invoice_date' order.id %}" method="post">
                                    {% csrf_token %}
                                    <input type="datetime-local" name="date" value="{{order.order_date}}" required>
                                    <button class="btn btn-outline-dark btn-sm" type="submit">Change</button>
                                </form>
                            </div>
                        </div>
                        <div class="card-body">
                            {% for message in messages %}
                            <div class="alert {{message.tags}} " role="alert">
                                <div class="iq-alert-text"><b></b> {{message}}</div>
                            </div>
                            {% endfor %}
                            <form id="orderForm">
                                <div class="input-group mb-3">
                                    <input type="hidden" id="orderId" name="order_id" value="{{ order.id }}">
                                    <label for="">Customer: </label>
                                    <input type="text" id="customerInput" name="customer" placeholder="Choose Customer"
                                        aria-describedby="button-addon2" class="form-control"
                                        value="{{ order.customer }}">
                                    <button class="btn btn-outline-primary" type="button" data-toggle="modal"
                                        data-target=".bd-example-modal-lg" data-toggle="tooltip" data-placement="top"
                                        title="" data-original-title="Add Customer" id="button-addon2">
                                        <svg class="svg-icon" id="p-dash10" width="20" height="20"
                                            xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                            <circle cx="8.5" cy="7" r="4"></circle>
                                            <polyline points="17 11 19 13 23 9"></polyline>
                                        </svg>
                                    </button>
                                </div>
                            </form>
                            <form id="salesmanform">
                                <div class="input-group mb-3">
                                    <label for="">Sales Man: </label>
                                    <input type="hidden" id="orderId1" name="order_id" value="{{ order.id }}">
                                    <input type="text" id="salesmanInput" name="salesman" placeholder="Choose Sales Man"
                                        aria-describedby="button-addon2" class="form-control"
                                        value="{{ order.sales_man }}">
                                </div>
                            </form>


                            <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Add new Customer</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <form method="post" action="{%url 'add_customer' order.id %}">
                                                {% csrf_token %}
                                                <div class="row">
                                                    <div class="form-group col-md-6">
                                                        <label for="fname">Customer Name:</label>
                                                        <input type="text" class="form-control" name="name" id="fname"
                                                            placeholder="Customer Name" data-errors="Please Enter Name."
                                                            required>
                                                        <div class="help-block with-errors"></div>
                                                    </div>
                                                    <div class="form-group col-md-6">
                                                        <label for="lname">Phone:</label>
                                                        <input type="number" class="form-control" name="phone"
                                                            id="lname" placeholder="Phone Number">
                                                    </div>

                                                    <div class="form-group col-md-6">
                                                        <label for="email">Email:</label>
                                                        <input type="email" name="email" class="form-control" id="email"
                                                            placeholder="Email">
                                                    </div>
                                                    <div class="form-group col-md-6">
                                                        <div class="form-group">
                                                            <!-- <label>Gst Number:</label> -->
                                                            <input type="hidden" class="form-control" name="gst"
                                                                id="lname" placeholder="Gst Number">

                                                        </div>
                                                    </div>
                                                </div>
                                                <hr>
                                                <h5 class="mb-3">Address</h5>
                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <div class="form-group">
                                                            <label>Address</label>
                                                            <textarea class="form-control" rows="4"
                                                                name="contact_info"></textarea>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label>City *</label>
                                                            <input type="text" class="form-control"
                                                                placeholder="Enter City" name="city" required>
                                                            <div class="help-block with-errors"></div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label>State *</label>
                                                            <input type="text" class="form-control"
                                                                placeholder="Enter State" name="state" required>
                                                            <div class="help-block with-errors"></div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label>Country *</label>
                                                            <input type="text" class="form-control"
                                                                placeholder="Enter Country" name="country" required>
                                                            <div class="help-block with-errors"></div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label>Location G Map *</label>
                                                            <input type="text" class="form-control"
                                                                placeholder="Enter Location" name="pincode" required>
                                                            <div class="help-block with-errors"></div>
                                                        </div>
                                                    </div>
                                                </div>


                                                <button type="submit" class="btn btn-primary">Add Customer</button>
                                            </form>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary"
                                                data-dismiss="modal">Close</button>

                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="modal fade bd-example-modal-lg-product" tabindex="-1" role="dialog" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Add new Product</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <form method="post" action="{%url 'add_product_from_order' order.id %}" data-toggle="validator">
                                                {% csrf_token %}
                                                <div class="row">
                                                    {% for field in product_form%}
                                                    <div class="form-group col-md-6">
                                                        {{field.label_tag}}
                                                        {{field}}
                                                        <div class="help-block with-errors"></div>
                                                    </div>
                                                    {% endfor %}
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                           <label for="">Expiry Date <sup>(optional)</sup> </label>
                                                            <input type="date" name="ex_date" class="form-control" id="ex_date">
                                                            <div class="help-block with-errors"></div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                           <label for="">Manufacture Date <sup>(optional)</sup></label>
                                                            <input type="date" name="man_date" class="form-control" id="man_date">
                                                            <div class="help-block with-errors"></div>
                                                        </div>
                                                    </div>
                                                    
                                                </div>

                                                <button type="submit" class="btn btn-primary">Add Product</button>
                                            </form>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary"
                                                data-dismiss="modal">Close</button>

                                        </div>
                                    </div>
                                </div>
                            </div>



                        </div>
                    </div>

                    


                    <div class="tableitems" id="orderItemsTable">

                        {% include 'ajaxtemplates/order_items_table.html' %}
                    </div>
                    
                    
                    
                    
                   
                </div>




            </div>
        </div>
    </div>
    <div class="container mt-4">
        <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel">
            <div class="offcanvas-header">
              <h5 class="offcanvas-title" id="offcanvasExampleLabel">Recent Invoices</h5>
              <!-- <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button> -->
            </div>
            <div class="offcanvas-body">
    
                <div class="table-responsive rounded mb-3">
                    <table class="data-tables table mb-0 tbl-server-info">
                        <thead class="bg-white text-uppercase">
                            <tr class="ligth ligth-data">
                                <th>Order Number</th>
                                
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody class="ligth-body">
    
                            {% for m in invoice %}
                           
                            <tr>
                                <td>#{{m.invoice_number}}</td>
                                <td>Rs {{m.total_amount}}</td>
                                <th>
                                    {% if m.payment_status1 == 'UNPAID' %}
                                    <span class="badge bg-danger">{{m.payment_status1}}</span>
                                    {% elif m.payment_status1 == 'PAID' %}
                                    <span class="badge bg-success">{{m.payment_status1}}</span>
                                    {% elif m.payment_status1 == 'PARTIALLY' %}
                                    <span class="badge bg-warning">{{m.payment_status1}}</span>
                                    {% else %}
                                    <span class="badge bg-dark">UNKNOWN</span>
                                    {% endif %}
                                </th>
                                <td>
                                    <div class="d-flex align-items-center list-action">
                                      
                                        <a class="badge bg-success mr-2" data-toggle="tooltip"
                                            data-placement="top" title="" data-original-title="Edit" href="{%url 'POS' m.id %}"><i
                                                class="ri-pencil-line mr-0"></i></a>
                                    </div>
                                </td>
                            </tr>
                            
                            {% endfor %}
                            
                        </tbody>
                    </table>
                </div>
              
            </div>
          </div>
    </div>

    <!-- Wrapper End-->
    <footer class="iq-footer">
        <div class="container-fluid">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-6">
                            <ul class="list-inline mb-0">
                                <li class="list-inline-item"><a href="#">Privacy Policy</a></li>
                                <li class="list-inline-item"><a href="#">Terms of Use</a></li>
                            </ul>
                        </div>
                        <div class="col-lg-6 text-right">
                            <span class="mr-1">
                                <script>document.write(new Date().getFullYear())</script>Â©
                            </span> <a href="#" class="">BETA-POS</a>.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>
      
    {% endblock %}
    <!-- Backend Bundle JavaScript -->
    <script src="{%static 'assets/js/backend-bundle.min.js' %}"></script>

    <!-- Table Treeview JavaScript -->
    <script src="{%static 'assets/js/table-treeview.js' %}"></script>

    <!-- Chart Custom JavaScript -->
    <script src="{%static 'assets/js/customizer.js' %}"></script>

    <!-- Chart Custom JavaScript -->
    <script async src="{%static 'assets/js/chart-custom.js' %}"></script>

    <!-- app JavaScript -->
    <script src="{%static 'assets/js/app.js' %}"></script>
    <script src="{%static 'assets/js/jquery-3.6.0.min.js' %}"></script>
    <!-- <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> -->
     <script src="{%static 'assets/js/select2.min.js' %}"></script>
     <link rel="stylesheet" href="{%static 'assets/css/select2.min.css' %}">
    <!-- <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" /> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script> -->
    <!-- <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script> -->
     <script src="{%static 'assets/js/jquery-ui.min.js' %}"></script>
    <!-- custome scripts -->

    <script>
        $(document).ready(function () {
            if (typeof $.ui !== 'undefined') {
                console.log("jQuery UI loaded successfully.");
            } else {
                console.log("Error: jQuery UI not loaded.");
            }

            $(document).on('keydown', function (event) {
        // Check if Alt key and P key are pressed simultaneously
        if (event.altKey && event.key === 'p') {
            // Focus on the search input and select all text
            $('#search-input').focus().select();
        }
    });

    $(document).on('keydown', function (event) {
        // Check if Alt key and P key are pressed simultaneously
        if (event.altKey && event.key === 'c') {
            // Focus on the search input and select all text
            $('#customerInput').focus().select();
        }
    });

    $(document).on('keydown', function (event) {
        // Check if Alt key and P key are pressed simultaneously
        if (event.altKey && event.key === 's') {
            // Focus on the search input and select all text
            $('#salesmanInput').focus().select();
        }
    });

            var customers = [
                {% for customer in customer %}
                {
                    id: "{{ customer.id }}",
                    value: "{{ customer.name }}",
                    label: "{{ customer.name }}",
                    contact: "{{ customer.phone }}",
                    gst: "{{ customer.gst_number }}",
                    address: "{{ customer.city }}, {{ customer.state }}, {{ customer.country }} - {{ customer.pincode }}"
                },
                {% endfor %}
            ];

            var products = [
                {% for products in product %}
                {
                    id: "{{ products.id }}",
                    value: "{{ products.name }}",
                    label: "{{ products }}" + " {{product.unit_quantity}}" + " {{product.unit}}",
                    price: "{{ products.price }}",
                    stock: "{{ products.stock }}",
                    description: "{{ products.description }}"
                },
                {% endfor %}
            ];

            var salesman = [
                {% for man in salesmans %}
                {
                    id: "{{ man.id }}",
                    value: "{{ man.employee_name }}",
                    label: "{{ man.employee_name }}" + " {{man.emoloye_id}}",
                  
                },
                {% endfor %}
            ];

            // Customer autocomplete
            $("#customerInput").autocomplete({
                source: customers,
                select: function (event, ui) {
                    var selectedCustomer = ui.item;
                    console.log("Selected customer details:", selectedCustomer);

                    $("#customerInput").val(selectedCustomer.label);

                    updateOrderCustomer(selectedCustomer.id);

                    return false;
                }
            }).on("focus", function () {
                $(this).val("");
            });

            // Product autocomplete
            $("#search-input").autocomplete({
                source: products,
                select: function (event, ui) {
                    var selectedProduct = ui.item;
                    console.log("Selected product details:", selectedProduct);

                    $("#search-input").val(selectedProduct.label);

                    handleSelectedProduct(selectedProduct.id);

                    return false;
                }
            }).on("focus", function () {
                $(this).val("");
            });

             // Sales man autocomplete
             $("#salesmanInput").autocomplete({
                source: salesman,
                select: function (event, ui) {
                    var selectedSalesman = ui.item;
                    console.log("Selected product details:", selectedSalesman);

                    $("#salesmanInput").val(selectedSalesman.label);

                    updateSalesMan(selectedSalesman.id);

                    return false;
                }
            }).on("focus", function () {
                $(this).val("");
            });

            function updateOrderCustomer(customerId) {
                console.log("Updating order with customer ID:", customerId);
                $.ajax({
                    url: "{% url 'update_order_customer' %}",
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        customer_id: customerId,
                        order_id: '{{ order.id }}'
                    },
                    success: function (response) {
                        console.log("Order customer updated successfully.");
                        $("#customerdetails").html(response.html);
                    },
                    error: function (xhr, errmsg, err) {
                        console.log("Error updating order customer:", errmsg);
                    }
                });
            }

            function handleSelectedProduct(productId) {
                console.log("Handling selected product:", productId);
                // Add product handling logic here
                $.ajax({
                    url: "{% url 'add_order_item' order.id %}",
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        product_id: productId
                    },
                    success: function (response) {
                        if (response.success) {
                            $("#orderItemsTable").html(response.html);
                            $(response.order_item_id).focus().select();
                        } else {
                            alert(response.error);
                        }
                    },
                    error: function (xhr, errmsg, err) {
                        console.log("Error adding product to order:", errmsg);
                    }
                });
            }

            function updateSalesMan(customerId) {
                console.log("Updating order with customer ID:", customerId);
                $.ajax({
                    url: "{% url 'update_order_salesman' %}",
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        customer_id: customerId,
                        order_id: '{{ order.id }}'
                    },
                    success: function (response) {
                        console.log("Order Salesman updated successfully.");
                        $("#customerdetails").html(response.html);
                    },
                    error: function (xhr, errmsg, err) {
                        console.log("Error updating order customer:", errmsg);
                    }
                });
            }

            $(document).on('click', '.add-to-order', function (e) {
                e.preventDefault();
                var productId = $(this).data('product-id');
                
            });

            $(document).on('click', '.increase-quantity, .decrease-quantity', function (e) {
                e.preventDefault();
                var itemId = $(this).data('item-id');
                var action = $(this).hasClass('increase-quantity') ? 'increase' : 'decrease';
                $.ajax({
                    url: "{% url 'update_order_item_quantity' %}",
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        item_id: itemId,
                        action: action
                    },
                    success: function (response) {
                        if (response.success) {
                            $("#orderItemsTable").html(response.html);
                        } else {
                            alert(response.error);
                        }
                    },
                    error: function (xhr, errmsg, err) {
                        console.log("Error updating order item quantity:", errmsg);
                    }
                });
            });
        });


        $(document).ready(function () {
    // Attach event listeners to the price, quantity, and discount fields
    $('body').on('input', 'input[name="unit_price"], input[name="discount"], input[name="quantity"]', function () {
        var $row = $(this).closest('tr');
        var itemId = $row.find('button.increase-quantity').data('item-id');
        var unitPrice = parseFloat($row.find('input[name="unit_price"]').val()) || 0;
        var discount = parseFloat($row.find('input[name="discount"]').val()) || 0;
        var quantity = parseInt($row.find('input[name="quantity"]').val()) || 0;
        
        // Calculate the subtotal for the current row (client-side for immediate feedback)
        var subtotal = (unitPrice * quantity) - discount;
        $row.find('td:nth-child(5)').text(subtotal.toFixed(2));  // Update the Subtotal cell
        console.log(unitPrice,"-------------------------------------")
        // Send AJAX request to update the OrderItem on the backend
        $.ajax({
            url: "{% url 'update_order_item' order.id %}", // Your update view URL
            type: "POST",
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                item_id: itemId,
                unit_price: unitPrice,
                discount: discount,
                quantity: quantity
            },
            success: function (response) {
                if (response.success) {
                    // Update the grand total if necessary
                    $('input[name="total_amount"]').val(response.total_amount);
                    $('#balance-amount').val(response.balance_amount);
                    $('#total').val(response.total_amount);
                    $('#payment-status').text(response.payment_status);

                    // Log for debugging
                    console.log('Total Amount:', response.total_amount);
                    console.log('Balance Amount:', response.balance_amount);
                    console.log('Payment Status:', response.payment_status);
                    updateGrandTotal(response.total_amount);
                } else {
                    alert(response.error);
                }
            },
            error: function (xhr, errmsg, err) {
                console.log("Error updating order item:", errmsg);
            }
        });
    });
    
    // Function to update the grand total
    function updateGrandTotal(newTotal) {
        $('th.bg-info-light').last().text(newTotal.toFixed(2));
    }
});
document.getElementById('unit').required = true;
    </script>
    
</body>

</html>